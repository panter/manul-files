{"version":3,"sources":["../src/with_uploader.js"],"names":[],"mappings":"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","file":"with_uploader.js","sourcesContent":["import { useDeps, composeAll, composeWithTracker } from 'mantra-core';\nimport React from 'react';\nimport _ from 'lodash';\n\nexport const depsMapper = context => ({\n  context: () => context,\n});\n\nexport const composer = (\n  { context, uploader, alertsNamespace = 'upload', onUploadError = _.noop, onUploadSuccess = _.noop }\n  , onData) => {\n  const { Alerts } = context();\n  const getUploadCallback = (file, callback) => {\n    // check if Alerts has support for handleCallback\n    if (Alerts && Alerts.handleCallback) {\n      return Alerts.handleCallback(alertsNamespace, {\n        props: () => ({ file }),\n      },\n        callback,\n      );\n    }\n    // legacy\n    return (error, url) => {\n      if (error) {\n        onUploadError(error);\n      } else {\n        onUploadSuccess({ file, url });\n      }\n      callback(error, url);\n    };\n  };\n  const upload = (file, callback) => {\n    uploader.send(file, getUploadCallback(file, callback));\n  };\n  const progress = Math.round(uploader.progress() * 100);\n  const status = uploader.status();\n  // we use showFileError in FileField to indicate files that were already rejected by the dropzone\n  onData(null, { upload, progress, status });\n};\n\nexport const composeWithUploader = () => (C) => {\n  const WithUploader = class extends React.Component {\n    constructor(props, { uniforms } = {}) {\n      super(props);\n\n      const { uploadService } = props.context();\n      if (!uploadService) {\n        throw new Error('Please provide uploadService in your context');\n      }\n      this.directive = uploadService.Directives[props.directiveName];\n      // metaContext is available on the server when creating a key\n      // it can be a function and will be called with props and the uniforms' context\n      // if embedded on a fileField\n      // see collections/companies for an example\n      const metaContext = _.isFunction(props.metaContext) ?\n        props.metaContext(props, uniforms) :\n        props.metaContext;\n\n      this.uploader = uploadService.createUploader(props.directiveName, metaContext);\n    }\n    render() {\n      const props = this.props;\n\n      const CWithTracker = composeWithTracker(composer)(C);\n      const fileRestrictions = this.directive.fileRestrictions;\n\n      return (\n        <CWithTracker\n          {...props}\n          fileRestrictions={fileRestrictions}\n          uploader={this.uploader}\n        />\n      );\n    }\n  };\n  WithUploader.contextTypes = {\n    uniforms: React.PropTypes.object,\n  };\n\n  WithUploader.displayName = `withUploader(${C.displayName})`;\n\n  return WithUploader;\n};\n\n\nexport default C => composeAll(\n  composeWithUploader(),\n  useDeps(depsMapper),\n)(C);\n"]}