{"version":3,"sources":["../src/with_uploader.js"],"names":["depsMapper","context","composer","onData","uploader","alertsNamespace","onUploadError","onUploadSuccess","Alerts","getUploadCallback","file","callback","handleCallback","props","error","url","upload","send","progressDecimal","progress","Math","round","status","composeWithUploader","WithUploader","uniforms","uploadService","Error","directive","Directives","directiveName","metaContext","createUploader","CWithTracker","C","fileRestrictions","Component","contextTypes","object","displayName"],"mappings":"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","file":"with_uploader.js","sourcesContent":["import { useDeps, composeAll } from '@storybook/mantra-core';\n\nimport React from 'react';\nimport PropTypes from 'prop-types';\nimport _ from 'lodash';\nimport composeWithTracker from './composeWithTracker';\n\nexport const depsMapper = context => ({\n  context: () => context\n});\n\nexport const composer = (\n  {\n    context,\n    uploader,\n    alertsNamespace = 'upload',\n    onUploadError = _.noop,\n    onUploadSuccess = _.noop\n  },\n  onData\n) => {\n  const { Alerts } = context();\n  const getUploadCallback = (file, callback) => {\n    // check if Alerts has support for handleCallback\n    if (Alerts && Alerts.handleCallback) {\n      return Alerts.handleCallback(\n        alertsNamespace,\n        {\n          props: () => ({ file })\n        },\n        callback\n      );\n    }\n    // legacy\n    return (error, url) => {\n      if (error) {\n        onUploadError(error);\n      } else {\n        onUploadSuccess({ file, url });\n      }\n      callback(error, url);\n    };\n  };\n  const upload = (file, callback) => {\n    uploader.send(file, getUploadCallback(file, callback));\n  };\n  const progressDecimal = !_.isNaN(uploader.progress())\n    ? uploader.progress()\n    : 0;\n  const progress = Math.round(progressDecimal * 100);\n  const status = uploader.status();\n  // we use showFileError in FileField to indicate files that were already rejected by the dropzone\n  onData(null, { upload, progress, status });\n};\n\nexport const composeWithUploader = () => C => {\n  const WithUploader = class extends React.Component {\n    constructor(props, { uniforms } = {}) {\n      super(props);\n\n      const { uploadService } = props.context();\n      if (!uploadService) {\n        throw new Error('Please provide uploadService in your context');\n      }\n      this.directive = uploadService.Directives[props.directiveName];\n      // metaContext is available on the server when creating a key\n      // it can be a function and will be called with props and the uniforms' context\n      // if embedded on a fileField\n      // see collections/companies for an example\n      const metaContext = _.isFunction(props.metaContext)\n        ? props.metaContext(props, uniforms)\n        : props.metaContext;\n\n      this.uploader = uploadService.createUploader(\n        props.directiveName,\n        metaContext\n      );\n    }\n    render() {\n      const props = this.props;\n\n      const CWithTracker = composeWithTracker(composer)(C);\n      const fileRestrictions = this.directive.fileRestrictions;\n\n      return (\n        <CWithTracker\n          {...props}\n          fileRestrictions={fileRestrictions}\n          uploader={this.uploader}\n        />\n      );\n    }\n  };\n  WithUploader.contextTypes = {\n    uniforms: PropTypes.object\n  };\n\n  WithUploader.displayName = `withUploader(${C.displayName})`;\n\n  return WithUploader;\n};\n\nexport default C => composeAll(composeWithUploader(), useDeps(depsMapper))(C);\n"]}